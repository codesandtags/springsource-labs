<html><head>
      <meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
   <title>Introducing Aspect Oriented Programming</title><link rel="stylesheet" href="css/html.css" type="text/css"><meta name="generator" content="DocBook XSL Stylesheets V1.70.0"><link rel="start" href="index.html" title="Core Spring Training - Lab Documentation"><link rel="up" href="index.html" title="Core Spring Training - Lab Documentation"><link rel="prev" href="test-lab.html" title="Integration Testing with Profiles"><link rel="next" href="jdbc-lab.html" title="JDBC Simplification using the JdbcTemplate"></head><body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF"><div xmlns="http://www.w3.org/TR/xhtml1/transitional" style="background-color:white;border:none;height:73px;border:1px solid black;"><a style="border:none;" href="http://www.springframework.org/" title="The Spring Framework"><img style="border:none;" src="images/xdev-spring_logo.jpg"></img></a><a style="border:none;" href="http://www.springsource.com/" title="SpringSource"><img style="border:none;position:absolute;padding-top:5px;right:42px;" src="images/springsource-banner-rhs.jpg"></img></a></div><div class="chapter" lang="en"><div class="titlepage"><div><div><h2 class="title"><a name="aop-lab"></a>Introducing Aspect Oriented Programming</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-1-lab-introduction"></a>1.&nbsp;Introduction</h2></div></div></div><p>In this lab you will gain experience with aspect oriented
    programming (AOP) using the Spring AOP framework. You'll add cross-cutting
    behavior to the rewards application and visualize it.</p><div class="orderedlist"><p class="title"><b>What you will learn:</b></p><ol type="1"><li><p>How to write an aspect and weave it into your application</p></li><li><p>How to use STS to visualize where an aspect will be
        applied</p></li></ol></div><p>Estimated time to complete: 45 minutes</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-1-lab-quick-instructions"></a>2.&nbsp;Quick Instructions</h2></div></div></div><p>If you feel you have a good understanding of the material, you can
    work with the TODOs listed in the <code class="literal">Tasks</code> view in
    Eclipse/STS. To display them, click on Window -&gt; Show view -&gt; Tasks.
    Alternatively, the next section contains more detailed step-by-step
    instructions. Each task in STS is also described in more detail by a
    corresponding section in the step-by-step instructions. </p><p>Use the following quick instructions as a guide.</p><div class="orderedlist"><p class="title"><b>Creating and Testing a simple Aspect</b></p><ol type="1"><li><p><span class="bold"><strong>Create an Aspect</strong></span> (<a href="aop-lab.html#details.create-aspect" title="3.1.1.&nbsp;Create an aspect">details</a>)</p><p>Complete TODO-01 by marking your <code class="classname">LoggingAspect</code> class as an aspect. Complete TODO-02 by annotating the method you want to use as advice with both an advice type and the appropriate pointcut expression to select only <code class="classname">find*</code> methods.</p></li><li><p><span class="bold"><strong>Configure Spring to weave the aspect into the application</strong></span> (<a href="aop-lab.html#details.aspect-configure" title="3.1.2.&nbsp;Configure Spring to weave the aspect into the application">details</a>)</p><p>Edit the aspects.config file and complete TODO-03 by declaring your LoggingAspect class as a Spring bean. Complete TODO-04 by enabling Spring's AspectJ auto-proxy mechanism.</p></li><li><p><span class="bold"><strong>Test the Aspect implementation</strong></span> (<a href="aop-lab.html#details.aspect-test" title="3.1.3.&nbsp;Test the Aspect Implementation">details</a>)</p><p>Complete the configuration by importing the <code class="filename">aspect-config.xml</code> file so that it will be read by the <code class="classname">ApplicationContext</code> in the <code class="classname">LoggingAspectTest</code> class and run the tests (TODO-5).</p></li></ol></div><div class="orderedlist"><p class="title"><b>Visualizing Aspect Weaving</b></p><ol type="1"><li><p><span class="bold"><strong>Visualize beans cross reference</strong></span> (<a href="aop-lab.html#details.visualize-cross-ref" title="3.2.1.&nbsp;Visualize bean cross references">details</a>)</p><p>You can use the the Bean Cross References tool to view the
        aspect weaving into the Spring application. To do this, from the menu
        bar select <span class="emphasis"><em>Window -&gt; Show View -&gt; Other</em></span>
        option. Then, expand the Spring node and select Beans Cross
        References. You'll see the Beans Cross References view appear in the
        bottom page area. Try changing the Pointcut expression in your code,
        and you will see the relative changes in the Bean Cross References
        view.</p></li><li><p><span class="bold"><strong>Visualize using the AJDT Visualizer</strong></span> (<a href="aop-lab.html#details.visualize-ajdt" title="3.2.2.&nbsp;Visualize cross-cutting behavior application-wide with the AJDT Visualizer">details</a>)</p><p>Visualize the cross-cutting behavior application-wide with the
        AJDT Visualizer. Open the Aspect Visualization perspective by
        selecting <span class="emphasis"><em>Window -&gt; Open Perspective -&gt; Other... -&gt; Aspect Visualization</em></span> option. You will see all the classes
        in the project displayed with colored bands where an aspect is
        applied.</p></li></ol></div><div class="orderedlist"><p class="title"><b>Performance Monitor Aspect</b></p><ol type="1"><li><p><span class="bold"><strong>Implement Around advice</strong></span> (<a href="aop-lab.html#details.perf-monitor-aspect" title="3.3.&nbsp;Performance Monitor Aspect">details</a>)</p><p>Modify the <code class="classname">LoggingAspect</code> class to make the <code class="classname">monitor</code> method act as around advice (TODO-06 &amp; TODO-07) and write a pointcut expression to match on all <code class="classname">update*</code> methods on the repository classes.  Complete TODO-08 by modifying the configuration to  inject in the monitor factory into the <code class="classname">LoggingAspect</code> bean. Finally, re-run the tests on the <code class="classname"> LoggingAspectTest</code> class.</p></li></ol></div><div class="orderedlist"><p class="title"><b>Bonus: Exception Handling Aspect</b></p><ol type="1"><li><p><span class="bold"><strong>Implement &amp; Configure an Exception Handling aspect</strong></span> (<a href="aop-lab.html#details.exception-aspect" title="3.4.&nbsp;Exception Handling Aspect (Optional)">details</a>)</p><p>In this bonus exercise, annotate the <code class="classname">DBExceptionHandlingAspect</code> class to handle all exceptions thrown by any methods of the <code class="classname">Repository</code> classes (TODO-09)</p></li></ol></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h2 class="title" style="clear: both"><a name="aop-1-lab-instructions"></a>3.&nbsp;Detailed Instructions</h2></div></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2843"></a>3.1.&nbsp;Creating and Testing a simple Aspect (<code class="literal">@Before</code> advice)</h3></div></div></div><p>Up until now you have used Spring to configure and test your
      main-line application logic. Real-world enterprise applications also
      demand supporting services that cut across your main-line logic. An
      example would be logging: there may be many places in your application
      where you need to log data for monitoring. Historically, this may have
      lead to copying-and-pasting code, or entangling your application code
      with infrastructure. Today, you turn to aspect oriented programming
      (AOP). In the following steps you will create an aspect to monitor your
      application's data access performance.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="details.create-aspect"></a>3.1.1.&nbsp;Create an aspect</h4></div></div></div><p>In this step you will create a simple logging aspect. First you
        will define the logging behavior, then the rules about where the
        behavior should be applied. You'll use the <code class="literal">@Aspect</code>
        style.</p><p>The definition of the aspect has already been started for you.
        Find it in the <code class="literal">rewards.internal.aspects</code>
        package.</p><p>Open the <code class="classname">LoggingAspect.java</code> file and
        you'll see several TODOs for you to complete. First, complete TODO-01
        by annotating the <code class="classname">LoggingAspect</code> class with the
        <code class="literal">@Aspect</code> annotation. That will indicate this class
        is an aspect that contains cross-cutting behavior called "advice" that
        should be woven into your application.</p><p>You aren't interested in monitoring <span class="emphasis"><em>every</em></span>
        method of your application, though, only a subset. At this stage,
        you're only interested in monitoring the <code class="literal">find*</code>
        methods in your repositories, the objects responsible for data access
        in the application.</p><p>Therefore, define a pointcut expression that match all the
        <code class="literal">find*</code> methods (such as<code class="literal"> findByCreditCard()</code>) in the
        <code class="classname">AccountRepository</code>,
        <code class="classname">RestaurantRepository</code>, or
        <code class="classname">RewardRepository</code> interfaces (TODO-02). Use
        <code class="literal">@Before</code> advice, and implement the
        <code class="literal">implLogging()</code> method that takes a
        <code class="literal">JoinPoint</code> object as a parameter, and logs
        information about the target objects invoked during the application
        execution.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="details.aspect-configure"></a>3.1.2.&nbsp;Configure Spring to weave the aspect into the application</h4></div></div></div><p>Now that your aspect has been defined, you will create the
        Spring configuration needed to weave it into your application.</p><p>inside
        <code class="filename">rewards/internal/aspects/aspects-config.xml</code>,
        first define a bean of class <code class="classname">LoggingAspect</code>
        (TODO-03). This will deploy your aspect as a Spring bean. Next, add
        the <code class="literal">&lt;aop:aspectj-autoproxy&gt;</code> tag to this file
        (TODO-04). This instructs Spring to process beans that have the
        <code class="literal">@Aspect</code> annotation by weaving them into the
        application using the proxy pattern. This weaving behavior is shown
        graphically below:</p><div class="mediaobject" align="center"><img src="images/aop-1/autoproxycreator.png" align="middle"><div class="caption"><p>Figure 1: Spring's auto proxy creator weaving an aspect into
            the application using the proxy pattern</p></div></div><p>Figure 2 shows the internal structure of a created proxy and
        what happens when it is invoked:</p><div class="mediaobject" align="center"><img src="images/aop-1/proxystructure.png" align="middle"><div class="caption"><p>Figure 2: A proxy that applies logging behaviour to a
            <code class="classname">JdbcAccountRepository</code></p></div></div><div class="note" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Note"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Note]" src="images/note.png"></td><th align="left">Note</th></tr><tr><td align="left" valign="top"><p>It is not required, but it is generally recommended that you
          explicitly denote what beans are aspects in the XML configuration.
          To do this add an <code class="literal">&lt;aop:include/&gt;</code> tag inside
          of the <code class="literal">&lt;aop:aspectj-autoproxy&gt;</code> tag. The
          name attribute should reference the id of the bean that is an
          aspect.</p></td></tr></table></div><p>When you have your aspect defined as a Spring bean along with
        the autoproxy tag, move on to the next step!</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="details.aspect-test"></a>3.1.3.&nbsp;Test the Aspect Implementation</h4></div></div></div><p>To see this aspect in action, plug it into the application's
        system test configuration. To do that, simply add an import for
        <code class="filename">aspects-config.xml</code> in the
        <code class="filename">system-test-config.xml</code> file (TODO-05).</p><p>After the configuration file has been added, run
        <code class="classname">LoggingAspectTest</code> in Eclipse and watch the
        console.</p><pre class="programlisting">INFO : rewards.internal.aspects.LoggingAspect - 
'Before' Advice implementation - class rewards.internal.account.JdbcAccountRepository; 
Executing before findByCreditCard() method</pre><p>When you see the logging output, your aspect is being applied.
        Move on to the next step!</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="d0e2975"></a>3.2.&nbsp;Visualizing Aspect Weaving</h3></div></div></div><p>AOP is a powerful way of adding cross-cutting behavior to an
      application, but it can be difficult to visualize exactly where an
      aspect will be applied. In the following steps you will explore
      different ways to visualize aspects using STS. The SpringSource Tool
      Suite will have to know about your aspects config file, but as you added
      an <code class="literal">&lt;import/&gt;</code> statement in the previous step
      that's taken care of automatically.</p><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="details.visualize-cross-ref"></a>3.2.1.&nbsp;Visualize bean cross references</h4></div></div></div><p>With your aspect configuration added, you can now open the
        classes for both your aspect(s) and bean(s) and see visual indicators
        of cross-cutting behavior. To verify, first open your
        <code class="classname">LoggingAspect</code> class and scroll-down to the
        <code class="methodname">implLogging(JoinPoint)</code> method:</p><div class="mediaobject" align="center"><img src="images/aop-1/springide-gutter-1.png" align="middle"><div class="caption"><p>Figure 3: The arrow gutter icon indicates that the
            <code class="methodname">implLogging</code> method is a 'Before' advice
            that advises one or more beans</p></div></div><p>As another example, open
        <code class="classname">JdbcRestaurantRepository</code> and scroll to the
        <code class="methodname">findByMerchantNumber(String)</code> method:</p><div class="mediaobject" align="center"><img src="images/aop-1/springide-gutter-2.png" align="middle"><div class="caption"><p>Figure 4: The arrow gutter icon indicates the
            <code class="methodname">findByMerchantNumber</code> method is
            advised</p></div></div><p>These particular displays are somewhat limited because they only
        indicate a method is an advice or if it is being advised itself. For
        more information on what is being advised by an aspect you should turn
        on the Beans Cross References view. To do this, from the menu bar
        select <span class="emphasis"><em>Window -&gt; Show View -&gt; Other...</em></span>
        Then, expand the Spring node and select Beans Cross References. You'll
        see the Beans Cross References view appear in the bottom page
        area:</p><div class="mediaobject" align="center"><img src="images/aop-1/springide-beans-cross-references.png" align="middle"><div class="caption"><p>Figure 5: The <code class="classname">implLogging</code> before
            advice advises several beans</p></div></div><p></p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>If the cross references aren't being displayed, check that the
          view is "live" by clicking the icon with the two gold arrows
          pointing in opposite directions (it shows as a depressed button when
          it is active). If it still not visible, navigate to the project
          Properties &gt; Spring &gt; Bean Support option, and create a new
          Config Sets with the Spring bean configuration files.</p></td></tr></table></div><p>Explore the Beans Cross References view to see how the
        <code class="methodname">implLogging</code> before advice advises your beans,
        then move to the next step.</p></div><div class="section" lang="en"><div class="titlepage"><div><div><h4 class="title"><a name="details.visualize-ajdt"></a>3.2.2.&nbsp;Visualize cross-cutting behavior application-wide with the AJDT Visualizer</h4></div></div></div><p>The Beans Cross References view is a useful way of visualizing
        how a single aspect is applied to multiple classes. However, it
        doesn't provide a high-level visualization of all the cross-cutting
        behavior in your system. To provide this, STS integrates with the AJDT
        Aspect Visualization perspective.</p><p>Open the Aspect Visualization perspective by selecting
        <span class="emphasis"><em>Window -&gt; Open Perspective -&gt; Other... -&gt; Aspect Visualization</em></span>. When the perspective is open click on the
        <span class="emphasis"><em>Menu</em></span> pull down in the
        <span class="emphasis"><em>Visualize</em></span> view and choose
        <span class="emphasis"><em>Preferences</em></span>.</p><div class="mediaobject" align="center"><img src="images/aop-1/visualizer-preferences.png" align="middle"><div class="caption"><p>Figure 6: Open the visualizer preferences with the
            <span class="emphasis"><em>Menu</em></span> pull down</p></div></div><p>Next choose the Spring AOP provider and press OK. This will tell
        AJDT to use Spring AOP when drawing its aspect graphics.</p><div class="mediaobject" align="center"><img src="images/aop-1/spring-aop-provider.png" align="middle"><div class="caption"><p>Figure 7: The Spring AOP Provider</p></div></div><p>In the left most panel, select the
        <code class="literal">aop-1-start</code> project. You will see all of the
        classes in the project displayed with colored bands where an aspect is
        applied. In this example, you should see blue bands on your
        repositories indicating they are advised by the
        <code class="classname">RepositoryPerformanceMonitor</code>. This is shown
        below:</p><div class="mediaobject" align="center"><img src="images/aop-1/springide-visualizer.png" align="middle"><div class="caption"><p>Figure 8: The AJDT visualizer showing aspects
            application-wide</p></div></div><p>Explore the AJDT Visualizer.</p></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="details.perf-monitor-aspect"></a>3.3.&nbsp;Performance Monitor Aspect</h3></div></div></div><p>You will implement an <code class="classname">Around</code> Advice which
      logs the time spent in each of your <code class="literal">update</code> repository
      methods.</p><div class="itemizedlist"><ul type="disc"><li><p>Modify the <code class="classname">LoggingAspect</code> class, and
          implement the <code class="literal">monitor(ProceedingJoinPoint)</code>
          method. The method should start a monitor, proceed with the
          repository invocation, stop the monitor after the invocation
          returns, and log a report.</p></li><li><p>Specify <code class="literal">@Around</code> advice for the monitor
          method. Define a pointcut expression that matches all the
          <code class="literal">update*</code> methods (such as
          <code class="literal">JdbcAccountRepository.updateBeneficiaries(...)</code> on
          the <code class="classname">AccountRepository</code>,
          <code class="classname">RestaurantRepository</code>, or
          <code class="classname">RewardRepository</code> interfaces (TODO-06).</p></li><li><p>Now in <code class="literal">monitor(ProceedingJoinPoint)</code> method,
          notice the Monitor start and stop logic has already been written for
          you. What has not been written is the logic to proceed with the
          target method invocation after the watch is started. Complete
          TODO-07 by adding the <code class="literal">proceed</code> call. </p><div class="tip" style="margin-left: 0.5in; margin-right: 0.5in;"><table border="0" summary="Tip"><tr><td rowspan="2" align="center" valign="top" width="25"><img alt="[Tip]" src="images/tip.png"></td><th align="left">Tip</th></tr><tr><td align="left" valign="top"><p>Remember, the call to
              <code class="literal">repositoryMethod.proceed()</code> returns the target
              method's return value. Make sure to return that value out,
              otherwise you may change the value returned by a
              repository!</p></td></tr></table></div></li><li><p>Once you've added the proceed call, add the configurations in <code class="classname">aspects-config.xml</code> file (TODO-08) and run the
          <code class="classname">LoggingAspectTests</code> class in the test tree. If
          you can see relevant logging information in the console, your
          monitoring behavior has been implemented correctly.</p></li></ul></div></div><div class="section" lang="en"><div class="titlepage"><div><div><h3 class="title"><a name="details.exception-aspect"></a>3.4.&nbsp;Exception Handling Aspect (Optional)</h3></div></div></div><p>Create an exception handling aspect as follows:</p><div class="itemizedlist"><ul type="disc"><li><p>Modify the <code class="classname">DBExceptionHandlingAspect</code>
          class by implementing the method
          <code class="literal">implExceptionHandling(Exception e)</code> to report an
          exception.</p></li><li><p>Specify <code class="literal">@AfterThrowing</code> advice on top of
          this method. Define a pointcut expression that matches all the
          methods in the three repositories (regardless of the method
          names).</p></li><li><p>Modify the <code class="literal">aspects-config.xml</code> file to
          include this aspect.</p></li></ul></div></div><p>After the configuration has been added, run
    <code class="classname">RewardNetworkTests</code> in Eclipse and watch the
    console. If you can see relevant logging information in the console, your
    exception handling behavior has been implemented correctly.</p><p>Congratulations, you've completed the lab!</p></div></div><div xmlns="http://www.w3.org/TR/xhtml1/transitional" class="navfooter"><hr></hr><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="test-lab.html">Prev</a>&nbsp;</td><td width="20%" align="center"><a accesskey="h" href="index.html">Home</a></td><td width="40%" align="right">&nbsp;<a accesskey="n" href="jdbc-lab.html">Next</a></td></tr><tr><td width="40%" align="left" valign="top">Integration Testing with Profiles&nbsp;</td><td width="20%" align="center"><span style="color:white;font-size:90%;"><a href="http://www.springsource.com/" title="SpringSource">By SpringSource</a></span></td><td width="40%" align="right" valign="top">&nbsp;JDBC Simplification using the JdbcTemplate</td></tr></table></div></body></html>